<?php
use Drupal\Core\Database\Database;

require_once("lib/grid.php");
global $grid_lib;
$grid_lib=new grid_library();

/**
 * Created by PhpStorm.
 * User: enno
 * Date: 14.08.15
 * Time: 16:15
 */

function grid_get_storage()
{

    //TODO: find the templates path
    //TODO: port grid_drupal_ajaxendpoint over!


    $cache=&drupal_static(__FUNCTION__);
    if(!isset($cache))
    {
        $cache=array();
    }
    if(!isset($cache['loaded']))
    {
        \Drupal::moduleHandler()->invokeAll('grid_load_classes');
        $cache['loaded']=TRUE;
    }
    if(isset($cache['storage']))
    {
        return $cache['storage'];
    }

    $conn=Database::getConnection();
    $opts=$conn->getConnectionOptions();
    global $user;
    $username="UNDEFINED";
    if(isset($user->name))
        $username=$user->name;
    $storage=new grid_db($opts['host'],$opts['username'],$opts['password'],$opts['database'],$username,$conn->tablePrefix());

    //$storage->templatesPaths=grid_get_templates_paths();

    $config=\Drupal::config("grid.settings");
    $storage->containerstyle=$config->get("default_container_style");

    if($storage->containerstyle=='__NONE__')
        $storage->containerstyle=NULL;
    $storage->slotstyle=$config->get("defualt_slot_style");
    if($storage->slotstyle=='__NONE__')
        $storage->slotstyle=NULL;
    $storage->boxstyle=$config->get("default_box_style");
    if($storage->boxstyle=='__NONE__')
        $storage->boxstyle=NULL;
    $storage->ajaxEndpoint=new grid_ajaxendpoint();//new grid_drupal_ajaxendpoint();
    $storage->ajaxEndpoint->storage=$storage;
    $cache['storage']=$storage;
    return $storage;
}